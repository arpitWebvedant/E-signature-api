apiVersion: apps/v1
kind: Deployment
metadata:
  name: proof-backend
  namespace: staging
  labels:
    app: proof
    component: backend
    environment: staging
spec:
  replicas: 2
  selector:
    matchLabels:
      app: proof
      component: backend
  template:
    metadata:
      labels:
        app: proof
        component: backend
        environment: staging
    spec:
      containers:
        - name: backend
          image: 921840973142.dkr.ecr.us-west-2.amazonaws.com/proof-backend:staging-latest
          ports:
            - containerPort: 3011
              name: http
          env:
            # Centralized Auth URLs
            - name: NEXT_PRIVATE_CENTRALIZED_AUTH_BACKEND_URL
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_CENTRALIZED_AUTH_BACKEND_URL
            - name: NEXT_PRIVATE_CENTRALIZED_AUTH_FRONTEND_URL
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_CENTRALIZED_AUTH_FRONTEND_URL

            # API Configuration
            - name: NEXT_PRIVATE_API_BASE_URL
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_API_BASE_URL
            - name: FRONTEND_URL
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: FRONTEND_URL

            # Database Configuration
            - name: NEXT_PRIVATE_DB_HOST
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_DB_HOST
            - name: NEXT_PRIVATE_DB_PORT
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_DB_PORT
            - name: NEXT_PRIVATE_DB_USER
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_DB_USER
            - name: NEXT_PRIVATE_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_DB_PASSWORD
            - name: NEXT_PRIVATE_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_DB_NAME

            # Environment Configuration
            - name: NODE_ENV
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NODE_ENV
            - name: PORT
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: PORT
            - name: PRODUCT_NAME
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: PRODUCT_NAME

            # Missing Centralized Auth Backend URL (used by backend services)
            - name: CENTRALIZED_AUTH_BACKEND_URL
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_CENTRALIZED_AUTH_BACKEND_URL

            # Missing Frontend URL (used by document services)
            - name: NEXT_PRIVATE_FRONTEND_URL
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: FRONTEND_URL

            # S3 Upload Configuration
            - name: NEXT_PRIVATE_UPLOAD_BUCKET
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_UPLOAD_BUCKET
            - name: NEXT_PRIVATE_UPLOAD_TRANSPORT
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_UPLOAD_TRANSPORT
            - name: NEXT_PRIVATE_UPLOAD_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_UPLOAD_SECRET_ACCESS_KEY
            - name: NEXT_PRIVATE_UPLOAD_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_UPLOAD_ACCESS_KEY_ID
            - name: NEXT_PRIVATE_UPLOAD_REGION
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_UPLOAD_REGION
            - name: NEXT_PRIVATE_UPLOAD_FORCE_PATH_STYLE
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_UPLOAD_FORCE_PATH_STYLE

            # SMTP Configuration
            - name: NEXT_PRIVATE_SMTP_HOST
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_SMTP_HOST
            - name: NEXT_PRIVATE_SMTP_PORT
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_SMTP_PORT
            - name: NEXT_PRIVATE_SMTP_USER
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_SMTP_USER
            - name: NEXT_PRIVATE_SMTP_PASS
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_SMTP_PASS
            - name: NEXT_PRIVATE_SMTP_FROM
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_SMTP_FROM
            - name: NEXT_PRIVATE_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_JWT_SECRET

            # SMS SERVICE
            - name: NEXT_PRIVATE_SMS_BASE_URL
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_SMS_BASE_URL
            - name: NEXT_PRIVATE_SMS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: proof-backend-sealed-secret
                  key: NEXT_PRIVATE_SMS_API_KEY
          resources:
            requests:
              memory: "768Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          imagePullPolicy: Always
      tolerations:
        - key: staging
          operator: Equal
          value: "true"
          effect: NoSchedule
        - key: spot
          operator: Equal
          value: "true"
          effect: NoSchedule
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: proof-backend
  namespace: staging
  labels:
    app: proof
    component: backend
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 3011
      protocol: TCP
      name: http
  selector:
    app: proof
    component: backend
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: proof-backend
  namespace: staging
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-west-2:921840973142:certificate/88281aef-cdb3-4b19-a912-9171e35901a4
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/group.name: staging-backend-shared
    alb.ingress.kubernetes.io/group.order: "600"
    # Performance optimizations for API speed
    alb.ingress.kubernetes.io/load-balancer-attributes: |
      routing.http2.enabled=true,
      idle_timeout.timeout_seconds=300,
      access_logs.s3.enabled=false

    # Fast health checks for API
    alb.ingress.kubernetes.io/healthcheck-path: /api
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "3"
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"

    # API optimizations
    alb.ingress.kubernetes.io/backend-protocol: HTTP
    alb.ingress.kubernetes.io/success-codes: "200,201,204"
    alb.ingress.kubernetes.io/target-group-attributes: |
      deregistration_delay.timeout_seconds=5,
      stickiness.enabled=true,
      stickiness.type=lb_cookie
spec:
  rules:
    - host: proof-app.stg-omnisai.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: proof-backend
                port:
                  number: 80
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: proof-backend
  namespace: staging
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: proof-backend
  minReplicas: 2
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 65
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
